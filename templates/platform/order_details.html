{% extends 'platform/common.html' %}
{% load static %}

{% block content %}

<style>

select.form-control:not([size]):not([multiple]) {
    height: 44px;
}
select.form-control {
    padding-right: 38px;
    background-position: center right 17px;
    background-image: url(data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvâ€¦9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K);
    background-repeat: no-repeat;
    background-size: 9px 9px;
}
.form-control:not(textarea) {
    height: 44px;
}
.form-control {
    padding: 0 18px 3px;
    border: 1px solid #dbe2e8;
    border-radius: 22px;
    background-color: #fff;
    color: #606975;
    font-family: "Maven Pro",Helvetica,Arial,sans-serif;
    font-size: 14px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.shopping-cart .table,
.wishlist-table .table,
.order-table .table {
    margin-bottom: 0
}

.shopping-cart .btn,
.wishlist-table .btn,
.order-table .btn {
    margin: 0
}

.shopping-cart>table>thead>tr>th,
.shopping-cart>table>thead>tr>td,
.shopping-cart>table>tbody>tr>th,
.shopping-cart>table>tbody>tr>td,
.wishlist-table>table>thead>tr>th,
.wishlist-table>table>thead>tr>td,
.wishlist-table>table>tbody>tr>th,
.wishlist-table>table>tbody>tr>td,
.order-table>table>thead>tr>th,
.order-table>table>thead>tr>td,
.order-table>table>tbody>tr>th,
.order-table>table>tbody>tr>td {
    vertical-align: middle !important
}

.shopping-cart>table thead th,
.wishlist-table>table thead th,
.order-table>table thead th {
    padding-top: 17px;
    padding-bottom: 17px;
    border-width: 1px
}

.shopping-cart .remove-from-cart,
.wishlist-table .remove-from-cart,
.order-table .remove-from-cart {
    display: inline-block;
    color: #ff5252;
    font-size: 18px;
    line-height: 1;
    text-decoration: none
}

.shopping-cart .count-input,
.wishlist-table .count-input,
.order-table .count-input {
    display: inline-block;
    width: 100%;
    width: 86px
}

.shopping-cart .product-item,
.wishlist-table .product-item,
.order-table .product-item {
    display: table;
    width: 100%;
    min-width: 150px;
    margin-top: 5px;
    margin-bottom: 3px
}

.shopping-cart .product-item .product-thumb,
.shopping-cart .product-item .product-info,
.wishlist-table .product-item .product-thumb,
.wishlist-table .product-item .product-info,
.order-table .product-item .product-thumb,
.order-table .product-item .product-info {
    display: table-cell;
    vertical-align: top
}

.shopping-cart .product-item .product-thumb,
.wishlist-table .product-item .product-thumb,
.order-table .product-item .product-thumb {
    width: 130px;
    padding-right: 20px
}

.shopping-cart .product-item .product-thumb>img,
.wishlist-table .product-item .product-thumb>img,
.order-table .product-item .product-thumb>img {
    display: block;
    width: 100%
}

@media screen and (max-width: 860px) {
    .shopping-cart .product-item .product-thumb,
    .wishlist-table .product-item .product-thumb,
    .order-table .product-item .product-thumb {
        display: none
    }
}

.shopping-cart .product-item .product-info span,
.wishlist-table .product-item .product-info span,
.order-table .product-item .product-info span {
    display: block;
    font-size: 13px
}

.shopping-cart .product-item .product-info span>em,
.wishlist-table .product-item .product-info span>em,
.order-table .product-item .product-info span>em {
    font-weight: 500;
    font-style: normal
}

.shopping-cart .product-item .product-title,
.wishlist-table .product-item .product-title,
.order-table .product-item .product-title {
    margin-bottom: 6px;
    padding-top: 5px;
    font-size: 16px;
    font-weight: 500
}

.shopping-cart .product-item .product-title>a,
.wishlist-table .product-item .product-title>a,
.order-table .product-item .product-title>a {
    transition: color .3s;
    color: #374250;
    line-height: 1.5;
    text-decoration: none
}

.shopping-cart .product-item .product-title>a:hover,
.wishlist-table .product-item .product-title>a:hover,
.order-table .product-item .product-title>a:hover {
    color: #0da9ef
}

.shopping-cart .product-item .product-title small,
.wishlist-table .product-item .product-title small,
.order-table .product-item .product-title small {
    display: inline;
    margin-left: 6px;
    font-weight: 500
}

.wishlist-table .product-item .product-thumb {
    display: table-cell !important
}

@media screen and (max-width: 576px) {
    .wishlist-table .product-item .product-thumb {
        display: none !important
    }
}

.shopping-cart-footer {
    display: table;
    width: 100%;
    padding: 10px 0;
    border-top: 1px solid #e1e7ec
}

.shopping-cart-footer>.column {
    display: table-cell;
    padding: 5px 0;
    vertical-align: middle
}

.shopping-cart-footer>.column:last-child {
    text-align: right
}

.shopping-cart-footer>.column:last-child .btn {
    margin-right: 0;
    margin-left: 15px
}

@media (max-width: 768px) {
    .shopping-cart-footer>.column {
        display: block;
        width: 100%
    }
    .shopping-cart-footer>.column:last-child {
        text-align: center
    }
    .shopping-cart-footer>.column .btn {
        width: 100%;
        margin: 12px 0 !important
    }
}

.coupon-form .form-control {
    display: inline-block;
    width: 100%;
    max-width: 235px;
    margin-right: 12px;
}

.form-control-sm:not(textarea) {
    height: 36px;
}

</style>

<style>
      .search-box{
        width: fit-content;
        height: fit-content;
        position: relative;
      }
      .input-search{
        height: 30px;
        width: 30px;
        border-style: none;
        padding: 10px;
        font-size: 18px;
        letter-spacing: 2px;
        outline: none;
        border-radius: 50px;
        transition: all .5s ease-in-out;
        background-color: white;
        padding-right: 20px;
        color:black;
      }
      .input-search::placeholder{
        color:black;
        font-size: 18px;
        letter-spacing: 2px;
        font-weight: 100;
      }
      .btn-search{
        width: 30px;
        height: 30px;
        border-style: none;
        font-size: 20px;
        font-weight: bold;
        outline: none;
        cursor: pointer;
        border-radius: 50%;
        position: absolute;
        right: 0px;
        color:black ;
        background-color:transparent;
        pointer-events: painted;  
      }
      .btn-search:focus ~ .input-search{
        width: 300px;
        border-radius: 0px;
        background-color: transparent;
        border-bottom:1px solid rgba(255,255,255,.5);
        transition: all 500ms cubic-bezier(0, 0.110, 0.35, 2);
      }
      .input-search:focus{
        width: 300px;
        border-radius: 0px;
        background-color: transparent;
        border-bottom:1px solid gray;
        transition: all 500ms cubic-bezier(0, 0.110, 0.35, 2);
      }
  </style>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

<div class="container" style="margin-top: 30px; text-align: center;">
    <div class="heading-section">
      <h2>My Orders</h2>
    </div>
    <div class="container padding-bottom-3x mb-1">

        <form action="../../search" method="get">
            <div class="search-box">
                <button class="btn-search" type="submit"><i class="fas fa-search"></i></button>
                <input type="text" name="query" id="searchInput" class="input-search" placeholder="Type to Search...">
            </div>
        </form>
          

    <!--orders-->
    <div class="table-responsive shopping-cart" style="margin-top: 30px; margin-bottom: 30px; background-color: white;">
        {% if not order_items %}
        <div class="empty-cart-message" style="margin-bottom: 20px;">
          <center>
            <i class="fa-solid fa-bag-shopping my-3 opacity-75" style="color: #000000; font-size:90px"></i>
            <h2 class="cart-heading" >You have no Orders Yet</h2>
            <p class="cart-subheading text-secondary">There are no items in your Orders. <br> Order items from StyleNest</p>
            <a href="{% url "shop" %}"><button type="button" class="btn btn-primary">Shop now</button></a>
          </center>
        </div>
        {% else %}
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th class="text-center">Qty</th>
                    <th class="text-center">Price/Qty</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in order_items %}
                <tr>
                    <td>
                        <div class="product-item">
                            <a class="product-thumb" href="../prod_details/{{order.ord_product.id}}"><img src="{{order.ord_product.images.first.Pro_image.url}}" alt="Product"></a>
                            <div class="product-info">
                                <h4 class="product-title"><a href="../prod_details/{{order.ord_product.id}}">{{order.ord_product.Pro_name}}</a></h4>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <h6>{{order.ord_quantity}}</h6>
                    </td>
                    <td class="text-center text-lg text-medium">&#8377; {{order.price}}</td>
                    <td class="text-center text-lg text-medium"><span class="badge {% if order.status == "Cancelled" %}text-danger {% elif order.status == "Delivered" %} text-success {% elif order.status == "Order confirmed" %} text-warning {% elif order.status == "Order Pending" %} text-warning {% else %}text-primary{% endif %}">{{order.status}}<span></td>
                    {% if order.status == "Cancelled" or order.status == "Returned" %}
                    <td><a href="../prod_details/{{order.ord_product.id}}" class="btn btn-sm btn-outline-primary">View Product<a></td>
                    
                    {% elif order.status == "Order Pending" %}
                    <td><a href="../checkout/{{order.ord_product.id}}" class="btn btn-sm btn-outline-primary">Continue<a></td>

                    {% elif order.status == "Order Pending" %}
                    <td><button class="btn btn-sm btn-outline-secondary" onclick="continuePayment({{ order.id }})">Return</button></td>

                    {% else %}
                    <td><button class="delete btn btn-sm btn-outline-danger" onclick="cancelOrder({{ order.id }})">Cancel</button></td>
                    {% endif %}
                {% endfor %}
                </tbody>
             </table>
        {% endif %}
        </div>
    </div>

    <div aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if order_items.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ order_items.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            {% endif %}
            
            {% for num in order_items.paginator.page_range %}
                <li class="page-item {% if order_items.number == num %}active{% endif %}">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% endfor %}
            
            {% if order_items.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ order_items.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
            {% endif %}
        </ul>
    </div>

</div>


<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<script>
    function getCSRFToken() {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length, cookie.length);
            }
        }
        return '';
    }
</script>

<!--cancel function-->
<script>

    function cancelOrder(orderId) {
        Swal.fire({
            title: "Are you sure want to cancel?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, Cancel it!"
        }).then((willCancel) => {
            if (willCancel.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: '../cancel_order/' + orderId + '/',
                    data: {
                        csrfmiddlewaretoken: getCSRFToken()
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#order-' + orderId).remove();
                            location.reload();
                        } else {
                            swal("message", "Failed to cancel order");
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        swal("message", "Failed to cancel order");
                    }
                });
            }
        });
    }
    
</script>

<script>
    //function for return product-info
    function returnOrder(orderId) {
        Swal.fire({
            title: "Are you sure want to Return it?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, Return it!"
        }).then((willReturn) => {
            if (willReturn.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: '../return_order/' + orderId + '/',
                    data: {
                        csrfmiddlewaretoken: getCSRFToken()
                    },
                    success: function(response) {
                        if (response && response.success) { 
                            $('#order-' + orderId).remove();
                            location.reload();
                        } else {
                            console.error("Failed to return order");
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.error("Failed to return order");
                    }
                });
            }
        });
    }
    
</script>

{% endblock %}
