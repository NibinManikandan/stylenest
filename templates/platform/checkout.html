{% extends "platform/common.html" %}
{% load static %}  

{% block content %}
	
<div class="untree_co-section">
	<div class="intro-excerpt">
		<h1 style="text-align: center;">Checkout</h1>
	</div>
		<div class="container">
			{% if user.is_authenticated %}
			<div class="row mb-5">
				<div class="col-md-12">
				</div>
			</div>
			{% else %}
			<div class="row mb-5">
			<div class="col-md-12">
			<div class="border p-4 rounded" role="alert">
				Returning customer? <a href="{% url 'Userlogin' %}">Click here</a> to login
			</div>
			</div>
		</div>
			{% endif %}
		<div class="row">
		<div class="col-md-6 mb-5 mb-md-0">
			<h2 class="h3 mb-3 text-black">Shipping Details</h2>
			<div class="p-3 p-lg-5 border bg-white" style="min-height: 500px;">
				<div class="form-group row col-12">

					{% csrf_token %}
					{% if not addresses %}

					<div class="alert alert-warning" role="alert">
						<h4 class="alert-heading">Oops, No Address Found!</i></h4>
						<p>Looks like you haven't added an address yet. Please add a new address for delivery.</p>
						<hr>
					  </div>
					
					  {% else %}

					<!--current addresses section-->
						{% csrf_token %}
						{% for address in addresses %}
						<div class="card w-85 mb-3" style="border-radius: 5px;">
							<div class="card-body">
								<div class="form-check form-check-inline">
									<input class="form-check-input" type="radio"  name="select_address" id="address{{ address.id }}" value="{{ address.id }}">
									<label class="form-check-label"  for="address{{ address.id }}" >Address {{ forloop.counter }}</label>
								</div>
								<p  class="card-text">{{ address.first_name }} {{ address.last_name }}, {{ address.street_address }}, {{ address.landmark }} {{ address.city }}, {{ address.state }}, {{ address.pin_code }}, {{ address.country }}</p>
							</div>
						</div>
						{% endfor %}
					
					{% endif %}
					<!--address section end-->

			<!--another address section-->
			
			<div class="form-group" style="margin-top: 10px;">
				{% if not addresses %}
				<label for="c_ship_different_address" class="text-black" data-bs-toggle="collapse" href="#ship_different_address" role="button" aria-expanded="false" aria-controls="ship_different_address"><input type="checkbox" value="1" id="c_ship_different_address"> Where would you like your order shipped? </label>
				{% else %}
				<label for="c_ship_different_address" class="text-black" data-bs-toggle="collapse" href="#ship_different_address" role="button" aria-expanded="false" aria-controls="ship_different_address"><input type="checkbox" value="1" id="c_ship_different_address"> Ship to anothor Address? </label>
				{% endif %}

				<div class="collapse" id="ship_different_address">
					<div class="py-2">

						{% csrf_token %}
						<div class="form-group row">
						<div class="col-md-6">
						  <label for="c_diff_fname" class="text-black">First Name <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_diff_fname" name="fname" placeholder="First name">
						</div>
		
						<div class="col-md-6">
						  <label for="c_diff_lname" class="text-black">Last Name <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_diff_lname" name="lname" placeholder="Last name">
						</div>
						</div>
			  
						<div class="form-group row">
						  <div class="col-md-12">
						  <label for="c_address" class="text-black">Address <span class="text-danger">*</span></label>
						  <textarea class="form-control" type="text" name="c_address" id="exampleFormControlTextarea1" rows="2" placeholder="Street address"></textarea>
						  </div>
						</div>
				  
						<div class="form-group row">
						  <div class="col-md-12">
						  <label for="c_companyname" class="text-black">City <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_city" name="city" placeholder="City">
						  </div>
						</div>
						
						<div class="form-group row">
						  <div class="col-md-12">
						  <label for="c_companyname" class="text-black">Landmark <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_landmark" name="landmark" placeholder="Landmark">
						  </div>
						</div>
		
						<div class="form-group row">
						  <div class="col-md-6">
							<label for="c_diff_fname" class="text-black">Country <span class="text-danger">*</span></label>
							<input type="text" class="form-control" id="c_diff_fname" name="country" placeholder="Country">
						  </div>
			  
						<div class="form-group row">
						<div class="col-md-6">
						  <label for="c_diff_state_country" class="text-black">State <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_diff_state" name="state" placeholder="State">
						</div>
						
						<div class="col-md-6">
						  <label for="c_diff_postal_zip" class="text-black">Posta / Zip <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_diff_postal_zip" name="postal_zip" placeholder="Posta / Zip">
						</div>
						</div>
			  
						<div class="col-md-6">
						  <label for="c_diff_phone" class="text-black">Phone <span class="text-danger">*</span></label>
						  <input type="text" class="form-control" id="c_diff_phone" name="c_phone" placeholder="Alter native Phone Number">
						</div>
						</div>
						<hr />
						<button type="submit" class="btn btn-primary">Add New</button>
					  </div>
					{% comment %} </form> {% endcomment %}
				</div>
			    </div>
			</div>
			</div>
		</div>
		<!--end section-->

		<!--coupon section-->
		<div class="col-md-6">
			{% csrf_token %}
			<div class="row mb-5">
			<div class="col-md-12">
				<h2 class="h3 mb-3 text-black">Coupon Code</h2>
				<div class="p-3 p-lg-5 border bg-white">

				<label for="c_code" class="text-black mb-3">Enter your coupon code if you have one. </label> 
				<div class="input-group w-90 couponcode-wrap">
					<input type="text" class="form-control me-2" id="couponCode" placeholder="Coupon Code" aria-label="Coupon Code" aria-describedby="button-addon2">
					<div class="input-group-append">
					<button class="btn btn-black btn-sm" type="button" onclick="applyCoupon()" id="button-addon2" style="border-radius: 10px; margin-left: 10px; background-color: green;">Apply </button>
					</div>

					<div class="input-group-append">
						<button class="btn btn-black btn-sm" type="button" onclick="removeCoupon" id="button-addon2" style="border-radius: 10px; margin-left: 10px; background-color: darkred;">Cancel </button>
					</div>

				</div>
				<div class="input-group-append" style="margin-top: 20px;">
					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
						Available Coupons
					</button>
				</div>
				

				<!--coupons modal-->
				<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
					<div class="modal-dialog">
					  <div class="modal-content">
						<div class="modal-header">
						  <h5 class="modal-title" id="exampleModalLabel">Availabe Coupons</h5>
						  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<ul>
								{% for coupon in coupons %}
								<li>{{coupon.name}} - {{coupon.code}}</li>
								{% endfor %}
							</ul>
						</div>
					</div>
				</div>
			  </div>
			  <!--end modal-->

				</div>
			</div>
			</div>
			<!--coupon end-->

			<!--order Section-->
			<div class="row mb-5">
			<div class="col-md-12">
				<h2 class="h3 mb-3 text-black">Your Order</h2>
				<div class="p-3 p-lg-5 border bg-white">
				<table class="table site-block-order-table mb-5">
					<thead>
					<th>Product</th>
					<th>Total</th>
					</thead>
					<tbody>
						{% for items in obj  %}
					<tr>
						<td>{{items.product.Pro_name}} <strong class="mx-2"></td>
						<td>${{items.cart_price}}</td>
					</tr> 
					{% endfor %}
					<tr>
						<td class="text-black font-weight-bold"><strong>Cart Subtotal</td>
						<td class="text-black">${{total}}</td>
					</tr>
					<tr>
						<td class="text-black font-weight-bold"><strong>Order Total</strong></td>
						<td class="text-black font-weight-bold"><strong>${{total}}</strong></td>
					</tr>
					
					</tbody>
				</table>

				<h6 style="margin-bottom: 20px; color: black;">Choose your payment Source</h6>
				  <div class="form-check">
					<input class="form-check-input" type="radio" name="payment" value="COD" id="flexRadioDefault1" checked>
					<label class="form-check-label" for="flexRadioDefault1">
					  Cash On Delivery
					</label>
				  </div>
				  
				  <div class="form-check">
					<input class="form-check-input" type="radio" name="payment" value="razorepay" id="flexRadioDefault1">
					<label class="form-check-label" for="flexRadioDefault1">
					  Razorepay
					</label>
				  </div>
				  
				  <div class="form-check">
					<input class="form-check-input" type="radio" name="payment" value="wallet" id="flexRadioDefault2">
					<label class="form-check-label" for="flexRadioDefault2">
					  Wallet
					</label>
				  </div>

					<div>
						<div class="form-group" style="margin-top: 20px;">
							<button type="button" onclick="place_order()" id="placeOrderButton" class="btn btn-outline-black btn-sm btn-block" style="background-color: green;">Place Order</button>
						</div>
					</div>
				</div>
			  </div>
			</div>
			<!--order section end-->
		  </div>
		</div>
	</div>
</div>


<script>
	function showCouponModal() {
	  $('#couponModal').modal('show'); // Show the modal
	}
</script>

<script>
    function getCSRFToken() {
        // Implement the logic to retrieve the CSRF token
        // This might involve selecting an input element or using a different method
        return document.querySelector('input[name="csrfmiddlewaretoken"]').value;
      }
    function applyCoupon() {
        var couponCode = $('#couponCode').val();

        $.ajax({
            url: 'apply_coupons',
            type: 'POST',
            data: {
                couponCode: couponCode,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function (data) {
                // Handle the response from the server, e.g., update total prices
                console.log(data);

                if ('error' in data) {
                    // Display the error message below the input field
                    $('#couponError').text(data.error);
                } else {
                    $('.coupon-discount').text(data.discount_amount);
                    $('.final-total').text(data.total);
                    
                    // Clear the error message on success
                    $('#couponError').text('');
                    Swal.fire({
                        icon: 'success',
                        title: "Coupon Applied Successfully",
                        confirmButtonText: 'OK',
                    });
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error:', errorThrown);

                // Display a generic error message below the input field
                $('#couponError').text('Error applying coupon. Please try again.');
            }
        });
    }
    function removeCoupon() {
        var couponCode = $('#couponCode').val();
        console.log("clicked")
    
        $.ajax({
            url: 'remove_coupon',
            type: 'POST',
            data: {
                couponCode: couponCode,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function (data) {
                // Handle the response from the server, e.g., update total prices
                console.log(data);
    
                if ('error' in data) {
                    // Display the error message below the input field
                    $('#couponError').text(data.error);
                } else {
                    $('.coupon-discount').text(''); // Clear the coupon discount display
                    $('.final-total').text(data.total);
    
                    // Clear the error message on success
                    $('#couponError').text('');
                    Swal.fire({
                        icon: 'success',
                        title: "Coupon Removed Successfully",
                        confirmButtonText: 'OK',
                    });
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error:', errorThrown);
    
                // Display a generic error message below the input field
                $('#couponError').text('Error removing coupon. Please try again.');
            }
        });
    }
	

    
</script>

<script>
    function place_order() {
		console.log('hello');
		var selectedAddress = $("input[name='select_address']:checked").val();
		var selectedPayment = $("input[name='payment']:checked").val();
		var csrfToken = $("input[name='csrfmiddlewaretoken']").val();
		console.log(selectedAddress);
		console.log(selectedPayment);
		if (selectedAddress && selectedPayment) {
			var data = {
				selected_address: selectedAddress,
				payment: selectedPayment,
				csrfmiddlewaretoken: csrfToken,
			};
	
			if (selectedPayment === 'COD') {
				$.ajax({
					url: '../place_order/',
					type: 'post',
					data: data,
					success: function(response) {
						if (response.success) {
							window.location.href='../view_order/'
						} else {
							Swal.fire({
								icon: 'error',
								title: 'Error',
								text: response.message,
								confirmButtonText: 'Ok'
							});
						}
					}
				});
			}
		}
	}
	
</script>


{% endblock %}